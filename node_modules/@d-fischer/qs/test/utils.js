'use strict';

var test = require('tape');
var inspect = require('object-inspect');
var SaferBuffer = require('safer-buffer').Buffer;
var forEach = require('for-each');
var utils = require('../lib/utils');

test('merge()', function (t) ***REMOVED***
    t.deepEqual(utils.merge(null, true), [null, true], 'merges true into null');

    t.deepEqual(utils.merge(null, [42]), [null, 42], 'merges null into an array');

    t.deepEqual(utils.merge(***REMOVED*** a: 'b' ***REMOVED***, ***REMOVED*** a: 'c' ***REMOVED***), ***REMOVED*** a: ['b', 'c'] ***REMOVED***, 'merges two objects with the same key');

    var oneMerged = utils.merge(***REMOVED*** foo: 'bar' ***REMOVED***, ***REMOVED*** foo: ***REMOVED*** first: '123' ***REMOVED*** ***REMOVED***);
    t.deepEqual(oneMerged, ***REMOVED*** foo: ['bar', ***REMOVED*** first: '123' ***REMOVED***] ***REMOVED***, 'merges a standalone and an object into an array');

    var twoMerged = utils.merge(***REMOVED*** foo: ['bar', ***REMOVED*** first: '123' ***REMOVED***] ***REMOVED***, ***REMOVED*** foo: ***REMOVED*** second: '456' ***REMOVED*** ***REMOVED***);
    t.deepEqual(twoMerged, ***REMOVED*** foo: ***REMOVED*** 0: 'bar', 1: ***REMOVED*** first: '123' ***REMOVED***, second: '456' ***REMOVED*** ***REMOVED***, 'merges a standalone and two objects into an array');

    var sandwiched = utils.merge(***REMOVED*** foo: ['bar', ***REMOVED*** first: '123', second: '456' ***REMOVED***] ***REMOVED***, ***REMOVED*** foo: 'baz' ***REMOVED***);
    t.deepEqual(sandwiched, ***REMOVED*** foo: ['bar', ***REMOVED*** first: '123', second: '456' ***REMOVED***, 'baz'] ***REMOVED***, 'merges an object sandwiched by two standalones into an array');

    var nestedArrays = utils.merge(***REMOVED*** foo: ['baz'] ***REMOVED***, ***REMOVED*** foo: ['bar', 'xyzzy'] ***REMOVED***);
    t.deepEqual(nestedArrays, ***REMOVED*** foo: ['baz', 'bar', 'xyzzy'] ***REMOVED***);

    var noOptionsNonObjectSource = utils.merge(***REMOVED*** foo: 'baz' ***REMOVED***, 'bar');
    t.deepEqual(noOptionsNonObjectSource, ***REMOVED*** foo: 'baz', bar: true ***REMOVED***);

    t.test(
        'avoids invoking array setters unnecessarily',
        ***REMOVED*** skip: typeof Object.defineProperty !== 'function' ***REMOVED***,
        function (st) ***REMOVED***
            var setCount = 0;
            var getCount = 0;
            var observed = [];
            Object.defineProperty(observed, 0, ***REMOVED***
                get: function () ***REMOVED***
                    getCount += 1;
                    return ***REMOVED*** bar: 'baz' ***REMOVED***;
            ***REMOVED***
                set: function () ***REMOVED*** setCount += 1; ***REMOVED***
            ***REMOVED***);
            utils.merge(observed, [null]);
            st.equal(setCount, 0);
            st.equal(getCount, 1);
            observed[0] = observed[0]; // eslint-disable-line no-self-assign
            st.equal(setCount, 1);
            st.equal(getCount, 2);
            st.end();
        ***REMOVED***
    );

    t.end();
***REMOVED***);

test('assign()', function (t) ***REMOVED***
    var target = ***REMOVED*** a: 1, b: 2 ***REMOVED***;
    var source = ***REMOVED*** b: 3, c: 4 ***REMOVED***;
    var result = utils.assign(target, source);

    t.equal(result, target, 'returns the target');
    t.deepEqual(target, ***REMOVED*** a: 1, b: 3, c: 4 ***REMOVED***, 'target and source are merged');
    t.deepEqual(source, ***REMOVED*** b: 3, c: 4 ***REMOVED***, 'source is untouched');

    t.end();
***REMOVED***);

test('combine()', function (t) ***REMOVED***
    t.test('both arrays', function (st) ***REMOVED***
        var a = [1];
        var b = [2];
        var combined = utils.combine(a, b);

        st.deepEqual(a, [1], 'a is not mutated');
        st.deepEqual(b, [2], 'b is not mutated');
        st.notEqual(a, combined, 'a !== combined');
        st.notEqual(b, combined, 'b !== combined');
        st.deepEqual(combined, [1, 2], 'combined is a + b');

        st.end();
    ***REMOVED***);

    t.test('one array, one non-array', function (st) ***REMOVED***
        var aN = 1;
        var a = [aN];
        var bN = 2;
        var b = [bN];

        var combinedAnB = utils.combine(aN, b);
        st.deepEqual(b, [bN], 'b is not mutated');
        st.notEqual(aN, combinedAnB, 'aN + b !== aN');
        st.notEqual(a, combinedAnB, 'aN + b !== a');
        st.notEqual(bN, combinedAnB, 'aN + b !== bN');
        st.notEqual(b, combinedAnB, 'aN + b !== b');
        st.deepEqual([1, 2], combinedAnB, 'first argument is array-wrapped when not an array');

        var combinedABn = utils.combine(a, bN);
        st.deepEqual(a, [aN], 'a is not mutated');
        st.notEqual(aN, combinedABn, 'a + bN !== aN');
        st.notEqual(a, combinedABn, 'a + bN !== a');
        st.notEqual(bN, combinedABn, 'a + bN !== bN');
        st.notEqual(b, combinedABn, 'a + bN !== b');
        st.deepEqual([1, 2], combinedABn, 'second argument is array-wrapped when not an array');

        st.end();
    ***REMOVED***);

    t.test('neither is an array', function (st) ***REMOVED***
        var combined = utils.combine(1, 2);
        st.notEqual(1, combined, '1 + 2 !== 1');
        st.notEqual(2, combined, '1 + 2 !== 2');
        st.deepEqual([1, 2], combined, 'both arguments are array-wrapped when not an array');

        st.end();
    ***REMOVED***);

    t.end();
***REMOVED***);

test('isBuffer()', function (t) ***REMOVED***
    forEach([null, undefined, true, false, '', 'abc', 42, 0, NaN, ***REMOVED******REMOVED***, [], function () ***REMOVED******REMOVED***, /a/g], function (x) ***REMOVED***
        t.equal(utils.isBuffer(x), false, inspect(x) + ' is not a buffer');
    ***REMOVED***);

    var fakeBuffer = ***REMOVED*** constructor: Buffer ***REMOVED***;
    t.equal(utils.isBuffer(fakeBuffer), false, 'fake buffer is not a buffer');

    var saferBuffer = SaferBuffer.from('abc');
    t.equal(utils.isBuffer(saferBuffer), true, 'SaferBuffer instance is a buffer');

    var buffer = Buffer.from && Buffer.alloc ? Buffer.from('abc') : new Buffer('abc');
    t.equal(utils.isBuffer(buffer), true, 'real Buffer instance is a buffer');
    t.end();
***REMOVED***);
