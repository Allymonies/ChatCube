'use strict';

var GetIntrinsic = require('get-intrinsic');

var $RangeError = GetIntrinsic('%RangeError%');
var $TypeError = GetIntrinsic('%TypeError%');

var assign = require('object.assign');

var isPropertyDescriptor = require('../helpers/isPropertyDescriptor');

var IsArray = require('./IsArray');
var IsAccessorDescriptor = require('./IsAccessorDescriptor');
var IsDataDescriptor = require('./IsDataDescriptor');
var OrdinaryDefineOwnProperty = require('./OrdinaryDefineOwnProperty');
var OrdinaryGetOwnProperty = require('./OrdinaryGetOwnProperty');
var ToNumber = require('./ToNumber');
var ToString = require('./ToString');
var ToUint32 = require('./ToUint32');
var Type = require('./Type');

// https://ecma-international.org/ecma-262/6.0/#sec-arraysetlength

// eslint-disable-next-line max-statements, max-lines-per-function
module.exports = function ArraySetLength(A, Desc) ***REMOVED***
	if (!IsArray(A)) ***REMOVED***
		throw new $TypeError('Assertion failed: A must be an Array');
	***REMOVED***
	if (!isPropertyDescriptor(***REMOVED***
		Type: Type,
		IsDataDescriptor: IsDataDescriptor,
		IsAccessorDescriptor: IsAccessorDescriptor
	***REMOVED***, Desc)) ***REMOVED***
		throw new $TypeError('Assertion failed: Desc must be a Property Descriptor');
	***REMOVED***
	if (!('[[Value]]' in Desc)) ***REMOVED***
		return OrdinaryDefineOwnProperty(A, 'length', Desc);
	***REMOVED***
	var newLenDesc = assign(***REMOVED******REMOVED***, Desc);
	var newLen = ToUint32(Desc['[[Value]]']);
	var numberLen = ToNumber(Desc['[[Value]]']);
	if (newLen !== numberLen) ***REMOVED***
		throw new $RangeError('Invalid array length');
	***REMOVED***
	newLenDesc['[[Value]]'] = newLen;
	var oldLenDesc = OrdinaryGetOwnProperty(A, 'length');
	if (!IsDataDescriptor(oldLenDesc)) ***REMOVED***
		throw new $TypeError('Assertion failed: an array had a non-data descriptor on `length`');
	***REMOVED***
	var oldLen = oldLenDesc['[[Value]]'];
	if (newLen >= oldLen) ***REMOVED***
		return OrdinaryDefineOwnProperty(A, 'length', newLenDesc);
	***REMOVED***
	if (!oldLenDesc['[[Writable]]']) ***REMOVED***
		return false;
	***REMOVED***
	var newWritable;
	if (!('[[Writable]]' in newLenDesc) || newLenDesc['[[Writable]]']) ***REMOVED***
		newWritable = true;
	***REMOVED*** else ***REMOVED***
		newWritable = false;
		newLenDesc['[[Writable]]'] = true;
	***REMOVED***
	var succeeded = OrdinaryDefineOwnProperty(A, 'length', newLenDesc);
	if (!succeeded) ***REMOVED***
		return false;
	***REMOVED***
	while (newLen < oldLen) ***REMOVED***
		oldLen -= 1;
		// eslint-disable-next-line no-param-reassign
		var deleteSucceeded = delete A[ToString(oldLen)];
		if (!deleteSucceeded) ***REMOVED***
			newLenDesc['[[Value]]'] = oldLen + 1;
			if (!newWritable) ***REMOVED***
				newLenDesc['[[Writable]]'] = false;
				OrdinaryDefineOwnProperty(A, 'length', newLenDesc);
				return false;
			***REMOVED***
		***REMOVED***
	***REMOVED***
	if (!newWritable) ***REMOVED***
		return OrdinaryDefineOwnProperty(A, 'length', ***REMOVED*** '[[Writable]]': false ***REMOVED***);
	***REMOVED***
	return true;
***REMOVED***;
