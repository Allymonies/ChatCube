/*!
 * forwarded
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */

'use strict'

/**
 * Module exports.
 * @public
 */

module.exports = forwarded

/**
 * Get all addresses in the request, using the `X-Forwarded-For` header.
 *
 * @param ***REMOVED***object***REMOVED*** req
 * @return ***REMOVED***array***REMOVED***
 * @public
 */

function forwarded (req) ***REMOVED***
  if (!req) ***REMOVED***
    throw new TypeError('argument req is required')
  ***REMOVED***

  // simple header parsing
  var proxyAddrs = parse(req.headers['x-forwarded-for'] || '')
  var socketAddr = getSocketAddr(req)
  var addrs = [socketAddr].concat(proxyAddrs)

  // return all addresses
  return addrs
***REMOVED***

/**
 * Get the socket address for a request.
 *
 * @param ***REMOVED***object***REMOVED*** req
 * @return ***REMOVED***string***REMOVED***
 * @private
 */

function getSocketAddr (req) ***REMOVED***
  return req.socket
    ? req.socket.remoteAddress
    : req.connection.remoteAddress
***REMOVED***

/**
 * Parse the X-Forwarded-For header.
 *
 * @param ***REMOVED***string***REMOVED*** header
 * @private
 */

function parse (header) ***REMOVED***
  var end = header.length
  var list = []
  var start = header.length

  // gather addresses, backwards
  for (var i = header.length - 1; i >= 0; i--) ***REMOVED***
    switch (header.charCodeAt(i)) ***REMOVED***
      case 0x20: /*   */
        if (start === end) ***REMOVED***
          start = end = i
        ***REMOVED***
        break
      case 0x2c: /* , */
        if (start !== end) ***REMOVED***
          list.push(header.substring(start, end))
        ***REMOVED***
        start = end = i
        break
      default:
        start = i
        break
    ***REMOVED***
  ***REMOVED***

  // final address
  if (start !== end) ***REMOVED***
    list.push(header.substring(start, end))
  ***REMOVED***

  return list
***REMOVED***
